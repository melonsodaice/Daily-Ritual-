<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Ritual ğŸŒ³</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root { --primary: #A8E063; --bg: #f9fbf2; --card: #ffffff; --text: #2d3436; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
        .tab-bar { display: flex; background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .tab-item { flex: 1; text-align: center; padding: 18px 0; font-weight: bold; color: #bbb; cursor: pointer; }
        .tab-item.active { color: #556b2f; border-bottom: 4px solid var(--primary); }
        .container { padding: 20px; max-width: 500px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #A8E063, #F7FF00); padding: 25px; border-radius: 24px; text-align: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(168,224,99,0.3); }
        .section-name { font-weight: bold; color: #556b2f; margin: 20px 0 10px; display: block; border-left: 5px solid var(--primary); padding-left: 10px; }
        .task-card { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.04); transition: 0.3s; }
        .task-input { border: none; font-size: 1.1rem; width: 55%; background: transparent; color: var(--text); }
        .btns { display: flex; gap: 5px; }
        button { border: none; padding: 10px 12px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .done { background: #55efc4; color: white; }
        .leave { background: #fab1a0; color: white; }
        .pending { background: #f0f0f0; color: #aaa; }
        .is-leave-mode { opacity: 0.6; text-decoration: line-through; }
        .stat-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-item { background: #f1f8e9; padding: 12px; border-radius: 12px; text-align: center; }
        .stat-num { font-size: 1.4rem; font-weight: bold; color: #388e3c; display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="tab-bar">
    <div class="tab-item active" onclick="showTab('daily')">Daily ğŸŒ¿</div>
    <div class="tab-item" onclick="showTab('weekly')">Weekly ğŸ</div>
    <div class="tab-item" onclick="showTab('monthly')">Monthly ğŸ</div>
</div>

<div class="container">
    <div class="header">
        <h1 style="margin:0; font-size:1.8rem;">My Ritual ğŸŒ³</h1>
        <div id="today-date" style="font-weight:bold; margin-top:5px; opacity:0.8;"></div>
    </div>

    <div id="tab-daily">
        <div id="task-list"></div>
        <div style="height:50px;"></div>
    </div>

    <div id="tab-weekly" class="hidden">
        <div class="stat-card">
            <span class="section-name">ğŸ“… æœ¬é€±é€±æœŸ (Mon-Fri)</span>
            <div id="week-range" style="font-size:1.5rem; font-weight:bold; color:#556b2f; margin:10px 0;"></div>
            <span class="section-name">ğŸ“Š è‡ªå‹•çµ±è¨ˆå®Œæˆæ•¸</span>
            <div class="stat-grid" id="week-stats"></div>
        </div>
    </div>

    <div id="tab-monthly" class="hidden">
        <div class="stat-card">
            <span class="section-name">ğŸ 2026 å¹´åº¦ç´¯è¨ˆ</span>
            <div id="month-display"></div>
        </div>
        <button onclick="if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šé‡ä¾†å—ï¼Ÿ')){localStorage.clear();location.reload();}" style="width:100%; background:none; border:none; color:#ccc; font-size:0.8rem; margin-top:20px;">é‡ç½®ç³»çµ±æ•¸æ“š</button>
    </div>
</div>

<script>
    const config = [
        { s: "â˜€ï¸ æ—©ä¸Š", ts: ["ğŸ“–", "ğŸ“–", "ğŸ’¼", "ğŸ‘ï¸"] },
        { s: "â˜• ä¸‹åˆ", ts: ["ğŸ“–", "ğŸ“–", "ğŸ’¼", "ğŸ‘ï¸"] },
        { s: "ğŸŒ™ æ™šä¸Š", ts: ["ğŸ“–", "ğŸ“–", "ğŸ", "ğŸ‘ï¸"] }
    ];

    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const todayId = `${now.getFullYear()}-${currentMonth}-${now.getDate()}`;

    function getWeekInfo() {
        let day = now.getDay() || 7; 
        let mon = new Date(now); mon.setDate(now.getDate() - day + 1);
        let fri = new Date(mon); fri.setDate(mon.getDate() + 4);
        return { range: `${mon.getMonth()+1}/${mon.getDate()} - ${fri.getMonth()+1}/${fri.getDate()}`, id: `W-${mon.getMonth()+1}${mon.getDate()}` };
    }
    const week = getWeekInfo();

    let tasks = JSON.parse(localStorage.getItem('ritual_txt_v6')) || {};
    let dailyStatus = JSON.parse(localStorage.getItem('ritual_status_v6')) || {};
    let stats = JSON.parse(localStorage.getItem('ritual_stats_v6')) || { weekId: week.id, w: {"ğŸ“–":0,"ğŸ’¼":0,"ğŸ":0,"ğŸ‘ï¸":0}, m: {} };

    // æ›é€±è‡ªå‹•é‡ç½®
    if (stats.weekId !== week.id) {
        stats.w = {"ğŸ“–":0,"ğŸ’¼":0,"ğŸ":0,"ğŸ‘ï¸":0};
        stats.weekId = week.id;
        dailyStatus = {}; 
        save();
    }
    if (!stats.m[currentMonth]) stats.m[currentMonth] = {"ğŸ“–":0,"ğŸ’¼":0,"ğŸ":0,"ğŸ‘ï¸":0};

    function render() {
        document.getElementById('today-date').innerText = now.toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'});
        let html = '';
        config.forEach((sec, sIdx) => {
            html += `<span class="section-name">${sec.s}</span>`;
            sec.ts.forEach((icon, tIdx) => {
                let id = `t-${sIdx}-${tIdx}`;
                let st = dailyStatus[todayId] ? (dailyStatus[todayId][id] || 'pending') : 'pending';
                let val = tasks[id] || (icon === 'ğŸ‘ï¸' ? 'çœ¼éƒ¨æ”¾é¬†' : (icon === 'ğŸ' ? 'é›œé …' : 'è®€æ›¸/å·¥ä½œå…§å®¹'));
                html += `
                    <div class="task-card ${st === 'leave' ? 'is-leave-mode' : ''}">
                        <span>${icon}</span>
                        <input class="task-input" value="${val}" onchange="saveTxt('${id}', this.value)">
                        <div class="btns">
                            <button class="${st === 'done' ? 'done' : 'pending'}" onclick="toggle('${id}', 'done', '${icon}')">å®Œæˆ</button>
                            <button class="${st === 'leave' ? 'leave' : 'pending'}" onclick="toggle('${id}', 'leave', '${icon}')">è«‹å‡</button>
                        </div>
                    </div>`;
            });
        });
        document.getElementById('task-list').innerHTML = html;
    }

    window.saveTxt = (id, v) => { tasks[id] = v; localStorage.setItem('ritual_txt_v6', JSON.stringify(tasks)); };

    window.toggle = (tid, targetType, icon) => {
        if (!dailyStatus[todayId]) dailyStatus[todayId] = {};
        let currentSt = dailyStatus[todayId][tid] || 'pending';
        
        // å¦‚æœåŸæœ¬æ˜¯ doneï¼Œç¾åœ¨è¦æ”¹æ‰ï¼Œå…ˆæ‰£æ‰çµ±è¨ˆ
        if (currentSt === 'done') {
            stats.w[icon]--;
            stats.m[currentMonth][icon]--;
        }

        // åˆ‡æ›ç‹€æ…‹
        if (currentSt === targetType) {
            dailyStatus[todayId][tid] = 'pending';
        } else {
            dailyStatus[todayId][tid] = targetType;
            // å¦‚æœæ–°ç‹€æ…‹æ˜¯ doneï¼ŒåŠ ä¸Šçµ±è¨ˆ
            if (targetType === 'done') {
                stats.w[icon]++;
                stats.m[currentMonth][icon]++;
            }
        }

        save();
        render();
    };

    function save() {
        localStorage.setItem('ritual_status_v6', JSON.stringify(dailyStatus));
        localStorage.setItem('ritual_stats_v6', JSON.stringify(stats));
    }

    window.showTab = (t) => {
        document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
        event.currentTarget.classList.add('active');
        ['daily', 'weekly', 'monthly'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        if (t === 'weekly') {
            document.getElementById('week-range').innerText = week.range;
            document.getElementById('week-stats').innerHTML = Object.entries(stats.w).map(([i, c]) => `<div class="stat-item"><span>${i} ç´¯ç©</span><span class="stat-num">${c}</span></div>`).join('');
        }
        if (t === 'monthly') {
            document.getElementById('month-display').innerHTML = Object.entries(stats.m).sort((a,b)=>b[0]-a[0]).map(([mon, data]) => `
                <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <b style="color:#556b2f;">${mon}æœˆ æˆæœå ±è¡¨</b>
                    <div class="stat-grid">${Object.entries(data).map(([i, c]) => `<span>${i} ${c}</span>`).join('')}</div>
                </div>`).join('');
        }
    };

    render();
</script>
</body>
</html>
